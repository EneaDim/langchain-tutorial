services:
  backend:
    build: ./backend
    ports: ["8000:8000"]
    environment:
      - LOG_LEVEL=info
      - DATABASE_URL=postgresql+psycopg2://ai:ai@postgres:5432/ai_doc
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/ready', timeout=5)"]
      interval: 10s
      timeout: 7s
      retries: 5

  ui:
    build: ./ui
    ports: ["8502:8501"]        # Apri http://localhost:8502
    environment:
      - API_URL=http://backend:8000
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8501/_stcore/health', timeout=5)"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:16
    environment:
      - POSTGRES_USER=ai
      - POSTGRES_PASSWORD=ai
      - POSTGRES_DB=ai_doc
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ai -d ai_doc"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7

volumes:
  pgdata:
