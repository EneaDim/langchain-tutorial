
x-common-env: &default-env
  PYTHONUNBUFFERED: "1"
  PYTHONPATH: /app:/opt/srw
  S3_BUCKET: ${S3_BUCKET}
  S3_REGION: ${S3_REGION}
  S3_ACCESS_KEY: ${S3_ACCESS_KEY}
  S3_SECRET_KEY: ${S3_SECRET_KEY}
  S3_ENDPOINT: ${S3_ENDPOINT}
  REDIS_URL: ${REDIS_URL}
  POSTGRES_DSN: ${POSTGRES_DSN}
  OLLAMA_BASE_URL: ${OLLAMA_BASE_URL}
  OLLAMA_MODEL: ${OLLAMA_MODEL}
  SRW_PER_FILE_CAP: ${SRW_PER_FILE_CAP}
  SRW_TOTAL_CAP: ${SRW_TOTAL_CAP}
  SRW_TEMPERATURE: ${SRW_TEMPERATURE}
  CORS_ORIGINS: ${CORS_ORIGINS}
  JWT_DEV_BEARER: ${JWT_DEV_BEARER}
  RATE_LIMIT_PER_MIN: ${RATE_LIMIT_PER_MIN}
  MAX_UPLOAD_MB: ${MAX_UPLOAD_MB}
  ALLOWED_MIME_LIST: ${ALLOWED_MIME_LIST}
  OIDC_ISSUER: ${OIDC_ISSUER}
  OIDC_AUDIENCE: ${OIDC_AUDIENCE}
  OIDC_CLIENT_ID: ${OIDC_CLIENT_ID}
  FEATURE_DOCX: ${FEATURE_DOCX}
  FEATURE_PII_REDACTION: ${FEATURE_PII_REDACTION}

volumes:
  shareddata:
  pgdata:
  minio_data:

services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    environment:
      <<: *default-env
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
      minio:
        condition: service_started
      createbucket:
        condition: service_completed_successfully

  worker:
    build:
      context: .
      dockerfile: api/workers/Dockerfile
    environment:
      <<: *default-env
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
      minio:
        condition: service_started
      createbucket:
        condition: service_completed_successfully
    volumes:
      - shareddata:/shared

  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
    environment:
      STREAMLIT_API_BASE: ${STREAMLIT_API_BASE:-http://localhost:8000}
    depends_on:
      api:
        condition: service_started
    volumes:
      - shareddata:/shared
